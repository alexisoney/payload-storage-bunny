{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import type {\n  Adapter,\n  PluginOptions as CloudStoragePluginOptions,\n  CollectionOptions,\n  GeneratedAdapter,\n} from '@payloadcms/plugin-cloud-storage/types'\nimport type { Config, Field } from 'payload'\n\nimport { cloudStoragePlugin } from '@payloadcms/plugin-cloud-storage'\n\nimport type { BunnyPlugin, BunnyStorageOptions } from './types.js'\n\nimport { getAdminThumbnail } from './adminThumbnail.js'\nimport { getGenerateURL } from './generateURL.js'\nimport { getHandleDelete } from './handleDelete.js'\nimport { getHandleUpload } from './handleUpload.js'\nimport { getStaticHandler } from './staticHandler.js'\nimport { validateOptions } from './utils.js'\n\nexport const bunnyStorage: BunnyPlugin =\n  (bunnyStorageOptions: BunnyStorageOptions) =>\n    (incomingConfig: Config): Config => {\n      if (bunnyStorageOptions.enabled === false) {\n        return incomingConfig\n      }\n\n      validateOptions(bunnyStorageOptions)\n\n      const adapter = bunnyInternal(bunnyStorageOptions)\n\n      const collectionsWithAdapter: CloudStoragePluginOptions['collections'] = Object.entries(\n        bunnyStorageOptions.collections,\n      ).reduce(\n        (acc, [slug, collOptions]) => ({\n          ...acc,\n          [slug]: {\n            ...(collOptions === true ? {} : collOptions),\n            adapter,\n          },\n        }),\n        {} as Record<string, CollectionOptions>,\n      )\n\n      const config: Config = {\n        ...incomingConfig,\n        collections: (incomingConfig.collections || []).map((collection) => {\n          if (!collectionsWithAdapter[collection.slug]) {\n            return collection\n          }\n\n          return {\n            ...collection,\n            upload: {\n              ...(typeof collection.upload === 'object' ? collection.upload : {}),\n              ...(bunnyStorageOptions.options.adminThumbnail ? {\n                adminThumbnail: getAdminThumbnail(collection, bunnyStorageOptions),\n              } : {}),\n              disableLocalStorage: true,\n            },\n          }\n        }),\n      }\n\n      return cloudStoragePlugin({\n        collections: collectionsWithAdapter,\n      })(config)\n    }\n\nconst bunnyInternal = ({ options }: BunnyStorageOptions): Adapter => {\n  const fields: Field[] = options.stream\n    ? [\n      {\n        name: 'bunnyVideoId',\n        type: 'text',\n        admin: {\n          disabled: true,\n          hidden: true,\n        },\n      },\n      ...(options.stream.mp4Fallback?.enabled || !!options.stream.mp4FallbackQuality\n        ? [\n          {\n            name: 'bunnyVideoMeta',\n            type: 'json' as const,\n            hidden: true,\n          },\n        ]\n        : []),\n    ]\n    : []\n\n  return ({ collection, prefix }): GeneratedAdapter => {\n    return {\n      name: 'bunny',\n      fields,\n      generateURL: getGenerateURL(options),\n      handleDelete: getHandleDelete(options),\n      handleUpload: getHandleUpload({ ...options, prefix }),\n      staticHandler: getStaticHandler({ ...options, collection, prefix }),\n    }\n  }\n}"],"names":["cloudStoragePlugin","getAdminThumbnail","getGenerateURL","getHandleDelete","getHandleUpload","getStaticHandler","validateOptions","bunnyStorage","bunnyStorageOptions","incomingConfig","enabled","adapter","bunnyInternal","collectionsWithAdapter","Object","entries","collections","reduce","acc","slug","collOptions","config","map","collection","upload","options","adminThumbnail","disableLocalStorage","fields","stream","name","type","admin","disabled","hidden","mp4Fallback","mp4FallbackQuality","prefix","generateURL","handleDelete","handleUpload","staticHandler"],"mappings":"AAQA,SAASA,kBAAkB,QAAQ,mCAAkC;AAIrE,SAASC,iBAAiB,QAAQ,sBAAqB;AACvD,SAASC,cAAc,QAAQ,mBAAkB;AACjD,SAASC,eAAe,QAAQ,oBAAmB;AACnD,SAASC,eAAe,QAAQ,oBAAmB;AACnD,SAASC,gBAAgB,QAAQ,qBAAoB;AACrD,SAASC,eAAe,QAAQ,aAAY;AAE5C,OAAO,MAAMC,eACX,CAACC,sBACC,CAACC;QACC,IAAID,oBAAoBE,OAAO,KAAK,OAAO;YACzC,OAAOD;QACT;QAEAH,gBAAgBE;QAEhB,MAAMG,UAAUC,cAAcJ;QAE9B,MAAMK,yBAAmEC,OAAOC,OAAO,CACrFP,oBAAoBQ,WAAW,EAC/BC,MAAM,CACN,CAACC,KAAK,CAACC,MAAMC,YAAY,GAAM,CAAA;gBAC7B,GAAGF,GAAG;gBACN,CAACC,KAAK,EAAE;oBACN,GAAIC,gBAAgB,OAAO,CAAC,IAAIA,WAAW;oBAC3CT;gBACF;YACF,CAAA,GACA,CAAC;QAGH,MAAMU,SAAiB;YACrB,GAAGZ,cAAc;YACjBO,aAAa,AAACP,CAAAA,eAAeO,WAAW,IAAI,EAAE,AAAD,EAAGM,GAAG,CAAC,CAACC;gBACnD,IAAI,CAACV,sBAAsB,CAACU,WAAWJ,IAAI,CAAC,EAAE;oBAC5C,OAAOI;gBACT;gBAEA,OAAO;oBACL,GAAGA,UAAU;oBACbC,QAAQ;wBACN,GAAI,OAAOD,WAAWC,MAAM,KAAK,WAAWD,WAAWC,MAAM,GAAG,CAAC,CAAC;wBAClE,GAAIhB,oBAAoBiB,OAAO,CAACC,cAAc,GAAG;4BAC/CA,gBAAgBzB,kBAAkBsB,YAAYf;wBAChD,IAAI,CAAC,CAAC;wBACNmB,qBAAqB;oBACvB;gBACF;YACF;QACF;QAEA,OAAO3B,mBAAmB;YACxBgB,aAAaH;QACf,GAAGQ;IACL,EAAC;AAEL,MAAMT,gBAAgB,CAAC,EAAEa,OAAO,EAAuB;IACrD,MAAMG,SAAkBH,QAAQI,MAAM,GAClC;QACA;YACEC,MAAM;YACNC,MAAM;YACNC,OAAO;gBACLC,UAAU;gBACVC,QAAQ;YACV;QACF;WACIT,QAAQI,MAAM,CAACM,WAAW,EAAEzB,WAAW,CAAC,CAACe,QAAQI,MAAM,CAACO,kBAAkB,GAC1E;YACA;gBACEN,MAAM;gBACNC,MAAM;gBACNG,QAAQ;YACV;SACD,GACC,EAAE;KACP,GACC,EAAE;IAEN,OAAO,CAAC,EAAEX,UAAU,EAAEc,MAAM,EAAE;QAC5B,OAAO;YACLP,MAAM;YACNF;YACAU,aAAapC,eAAeuB;YAC5Bc,cAAcpC,gBAAgBsB;YAC9Be,cAAcpC,gBAAgB;gBAAE,GAAGqB,OAAO;gBAAEY;YAAO;YACnDI,eAAepC,iBAAiB;gBAAE,GAAGoB,OAAO;gBAAEF;gBAAYc;YAAO;QACnE;IACF;AACF"}