{"version":3,"sources":["../src/staticHandlerStorage.ts"],"sourcesContent":["import type { StaticHandler } from '@payloadcms/plugin-cloud-storage/types'\nimport type { PayloadRequest } from 'payload'\n\nimport { posix } from 'node:path'\n\nimport type { BunnyAdapterOptions } from './types.js'\n\nexport const storageStaticHandler = async (\n  req: PayloadRequest,\n  data: Parameters<StaticHandler>[1],\n  filename: string,\n  storage: BunnyAdapterOptions['storage'],\n  prefix: string = '',\n): Promise<Response> => {\n  const rangeHeader = req.headers.get('range')\n\n  const requestHeaders = new Headers()\n  if (rangeHeader) {\n    requestHeaders.set('Range', rangeHeader)\n  }\n\n  const url = `https://${storage.hostname}/${posix.join(prefix, filename)}`\n\n  const response = await fetch(url, {\n    headers: requestHeaders,\n  })\n\n  if (!response.ok && response.status !== 206) {\n    return new Response(null, { status: 404, statusText: 'Not Found' })\n  }\n\n  const etagFromHeaders = req.headers.get('etag') || req.headers.get('if-none-match')\n  const objectEtag = response.headers.get('etag')\n\n  if (etagFromHeaders && objectEtag && etagFromHeaders === objectEtag) {\n    const responseHeaders = new Headers()\n    response.headers.forEach((value, key) => {\n      responseHeaders.set(key, value)\n    })\n\n    return new Response(null, {\n      headers: responseHeaders,\n      status: 304,\n    })\n  }\n\n  const responseHeaders = new Headers()\n  response.headers.forEach((value, key) => {\n    responseHeaders.set(key, value)\n  })\n\n  return new Response(response.body, {\n    headers: responseHeaders,\n    status: response.status,\n  })\n}"],"names":["posix","storageStaticHandler","req","data","filename","storage","prefix","rangeHeader","headers","get","requestHeaders","Headers","set","url","hostname","join","response","fetch","ok","status","Response","statusText","etagFromHeaders","objectEtag","responseHeaders","forEach","value","key","body"],"mappings":"AAGA,SAASA,KAAK,QAAQ,YAAW;AAIjC,OAAO,MAAMC,uBAAuB,OAClCC,KACAC,MACAC,UACAC,SACAC,SAAiB,EAAE;IAEnB,MAAMC,cAAcL,IAAIM,OAAO,CAACC,GAAG,CAAC;IAEpC,MAAMC,iBAAiB,IAAIC;IAC3B,IAAIJ,aAAa;QACfG,eAAeE,GAAG,CAAC,SAASL;IAC9B;IAEA,MAAMM,MAAM,CAAC,QAAQ,EAAER,QAAQS,QAAQ,CAAC,CAAC,EAAEd,MAAMe,IAAI,CAACT,QAAQF,WAAW;IAEzE,MAAMY,WAAW,MAAMC,MAAMJ,KAAK;QAChCL,SAASE;IACX;IAEA,IAAI,CAACM,SAASE,EAAE,IAAIF,SAASG,MAAM,KAAK,KAAK;QAC3C,OAAO,IAAIC,SAAS,MAAM;YAAED,QAAQ;YAAKE,YAAY;QAAY;IACnE;IAEA,MAAMC,kBAAkBpB,IAAIM,OAAO,CAACC,GAAG,CAAC,WAAWP,IAAIM,OAAO,CAACC,GAAG,CAAC;IACnE,MAAMc,aAAaP,SAASR,OAAO,CAACC,GAAG,CAAC;IAExC,IAAIa,mBAAmBC,cAAcD,oBAAoBC,YAAY;QACnE,MAAMC,kBAAkB,IAAIb;QAC5BK,SAASR,OAAO,CAACiB,OAAO,CAAC,CAACC,OAAOC;YAC/BH,gBAAgBZ,GAAG,CAACe,KAAKD;QAC3B;QAEA,OAAO,IAAIN,SAAS,MAAM;YACxBZ,SAASgB;YACTL,QAAQ;QACV;IACF;IAEA,MAAMK,kBAAkB,IAAIb;IAC5BK,SAASR,OAAO,CAACiB,OAAO,CAAC,CAACC,OAAOC;QAC/BH,gBAAgBZ,GAAG,CAACe,KAAKD;IAC3B;IAEA,OAAO,IAAIN,SAASJ,SAASY,IAAI,EAAE;QACjCpB,SAASgB;QACTL,QAAQH,SAASG,MAAM;IACzB;AACF,EAAC"}