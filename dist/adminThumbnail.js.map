{"version":3,"sources":["../src/adminThumbnail.ts"],"sourcesContent":["import type { CollectionConfig } from 'payload'\n\nimport { posix } from 'node:path'\n\nimport type { BunnyStorageOptions } from './types.js'\n\nimport { isImage } from './utils.js'\n\nexport const getAdminThumbnail = (collection: CollectionConfig, options: BunnyStorageOptions) => {\n  return ({ doc }: { doc: Record<string, unknown> }): null | string => {\n    const { adminThumbnail = true, storage, stream } = options.options\n    let timestamp = ''\n    if (doc.updatedAt) {\n      timestamp = Date.parse(doc.updatedAt as string).toString()\n    } else if (doc.createdAt) {\n      timestamp = Date.parse(doc.createdAt as string).toString()\n    }\n\n    const collectionOptions = options.collections[collection.slug]\n    const usePayloadAccessControl = typeof collectionOptions === 'object'\n      ? collectionOptions.disablePayloadAccessControl !== true\n      : false\n\n    if (doc.mimeType && isImage(doc.mimeType as string) && doc.filename && typeof doc.filename === 'string') {\n      const queryParams = new URLSearchParams()\n      if (timestamp) {\n        queryParams.append('t', timestamp)\n      }\n\n      if (adminThumbnail !== true && typeof adminThumbnail === 'object') {\n        if (adminThumbnail.queryParams) {\n          Object.entries(adminThumbnail.queryParams)\n            .forEach(([key, value]) => queryParams.append(key, String(value)))\n        }\n\n        if (adminThumbnail.appendTimestamp && timestamp && !queryParams.has('t')) {\n          queryParams.append('t', timestamp)\n        }\n      }\n\n      const baseUrl = usePayloadAccessControl\n        ? `/api/${collection.slug}/file/${doc.filename}`\n        : `https://${storage.hostname}/${posix.join(typeof doc.prefix === 'string' ? doc.prefix : '', doc.filename)}`\n\n      const queryString = queryParams.toString()\n      return queryString ? `${baseUrl}?${queryString}` : baseUrl\n    }\n\n    if (stream && doc.bunnyVideoId && typeof doc.bunnyVideoId === 'string') {\n      return usePayloadAccessControl\n        ? `/api/${collection.slug}/file/bunny:stream:${doc.bunnyVideoId}:thumbnail.jpg`\n        : `https://${stream.hostname}/${doc.bunnyVideoId}/thumbnail.jpg`\n    }\n\n    return null\n  }\n}"],"names":["posix","isImage","getAdminThumbnail","collection","options","doc","adminThumbnail","storage","stream","timestamp","updatedAt","Date","parse","toString","createdAt","collectionOptions","collections","slug","usePayloadAccessControl","disablePayloadAccessControl","mimeType","filename","queryParams","URLSearchParams","append","Object","entries","forEach","key","value","String","appendTimestamp","has","baseUrl","hostname","join","prefix","queryString","bunnyVideoId"],"mappings":"AAEA,SAASA,KAAK,QAAQ,YAAW;AAIjC,SAASC,OAAO,QAAQ,aAAY;AAEpC,OAAO,MAAMC,oBAAoB,CAACC,YAA8BC;IAC9D,OAAO,CAAC,EAAEC,GAAG,EAAoC;QAC/C,MAAM,EAAEC,iBAAiB,IAAI,EAAEC,OAAO,EAAEC,MAAM,EAAE,GAAGJ,QAAQA,OAAO;QAClE,IAAIK,YAAY;QAChB,IAAIJ,IAAIK,SAAS,EAAE;YACjBD,YAAYE,KAAKC,KAAK,CAACP,IAAIK,SAAS,EAAYG,QAAQ;QAC1D,OAAO,IAAIR,IAAIS,SAAS,EAAE;YACxBL,YAAYE,KAAKC,KAAK,CAACP,IAAIS,SAAS,EAAYD,QAAQ;QAC1D;QAEA,MAAME,oBAAoBX,QAAQY,WAAW,CAACb,WAAWc,IAAI,CAAC;QAC9D,MAAMC,0BAA0B,OAAOH,sBAAsB,WACzDA,kBAAkBI,2BAA2B,KAAK,OAClD;QAEJ,IAAId,IAAIe,QAAQ,IAAInB,QAAQI,IAAIe,QAAQ,KAAef,IAAIgB,QAAQ,IAAI,OAAOhB,IAAIgB,QAAQ,KAAK,UAAU;YACvG,MAAMC,cAAc,IAAIC;YACxB,IAAId,WAAW;gBACba,YAAYE,MAAM,CAAC,KAAKf;YAC1B;YAEA,IAAIH,mBAAmB,QAAQ,OAAOA,mBAAmB,UAAU;gBACjE,IAAIA,eAAegB,WAAW,EAAE;oBAC9BG,OAAOC,OAAO,CAACpB,eAAegB,WAAW,EACtCK,OAAO,CAAC,CAAC,CAACC,KAAKC,MAAM,GAAKP,YAAYE,MAAM,CAACI,KAAKE,OAAOD;gBAC9D;gBAEA,IAAIvB,eAAeyB,eAAe,IAAItB,aAAa,CAACa,YAAYU,GAAG,CAAC,MAAM;oBACxEV,YAAYE,MAAM,CAAC,KAAKf;gBAC1B;YACF;YAEA,MAAMwB,UAAUf,0BACZ,CAAC,KAAK,EAAEf,WAAWc,IAAI,CAAC,MAAM,EAAEZ,IAAIgB,QAAQ,EAAE,GAC9C,CAAC,QAAQ,EAAEd,QAAQ2B,QAAQ,CAAC,CAAC,EAAElC,MAAMmC,IAAI,CAAC,OAAO9B,IAAI+B,MAAM,KAAK,WAAW/B,IAAI+B,MAAM,GAAG,IAAI/B,IAAIgB,QAAQ,GAAG;YAE/G,MAAMgB,cAAcf,YAAYT,QAAQ;YACxC,OAAOwB,cAAc,GAAGJ,QAAQ,CAAC,EAAEI,aAAa,GAAGJ;QACrD;QAEA,IAAIzB,UAAUH,IAAIiC,YAAY,IAAI,OAAOjC,IAAIiC,YAAY,KAAK,UAAU;YACtE,OAAOpB,0BACH,CAAC,KAAK,EAAEf,WAAWc,IAAI,CAAC,mBAAmB,EAAEZ,IAAIiC,YAAY,CAAC,cAAc,CAAC,GAC7E,CAAC,QAAQ,EAAE9B,OAAO0B,QAAQ,CAAC,CAAC,EAAE7B,IAAIiC,YAAY,CAAC,cAAc,CAAC;QACpE;QAEA,OAAO;IACT;AACF,EAAC"}