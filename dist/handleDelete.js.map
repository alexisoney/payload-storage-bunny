{"version":3,"sources":["../src/handleDelete.ts"],"sourcesContent":["import type { HandleDelete } from '@payloadcms/plugin-cloud-storage/types'\n\nimport ky, { HTTPError } from 'ky'\nimport { posix } from 'node:path'\nimport { APIError } from 'payload'\n\nimport type { BunnyAdapterOptions } from './types.js'\n\nimport { getGenerateURL } from './generateURL.js'\nimport { getStorageUrl, getVideoFromDoc, purgeBunnyCache } from './utils.js'\n\nexport const getHandleDelete = ({ purge, storage, stream }: BunnyAdapterOptions): HandleDelete => {\n  return async ({ collection, doc, filename, req }) => {\n    try {\n      const video = getVideoFromDoc(doc, filename)\n\n      let fileUrl: null | string = null\n      if (!video && purge && purge.enabled) {\n        fileUrl = await getGenerateURL({ storage, stream })({\n          collection,\n          data: doc,\n          filename,\n          prefix: doc.prefix || '',\n        })\n      }\n\n      if (stream && video) {\n        await ky.delete(\n          `https://video.bunnycdn.com/library/${stream.libraryId}/videos/${video.videoId}`,\n          {\n            headers: {\n              accept: 'application/json',\n              AccessKey: stream.apiKey,\n            },\n            timeout: 120000,\n          },\n        )\n      } else {\n        const filePath = posix.join(doc.prefix || '', filename)\n\n        await ky.delete(\n          `https://${getStorageUrl(storage.region)}/${storage.zoneName}/${filePath}`,\n          {\n            headers: {\n              accept: 'application/json',\n              AccessKey: storage.apiKey,\n            },\n            timeout: 120000,\n          },\n        )\n\n        if (purge && purge.enabled && fileUrl) {\n          await purgeBunnyCache(fileUrl, purge, req)\n        }\n      }\n    } catch (err) {\n      if (err instanceof HTTPError) {\n        const errorResponse = await err.response.text()\n\n        req.payload.logger.error({\n          error: {\n            response: errorResponse,\n            status: err.response.status,\n            statusText: err.response.statusText,\n          },\n          file: { name: filename },\n          storage: storage.zoneName,\n        })\n      }\n\n      req.payload.logger.error({\n        error: err,\n        file: { name: filename },\n        storage: storage.zoneName,\n      })\n\n      throw new APIError(`Error deleting file: ${filename}`, 500)\n    }\n  }\n}"],"names":["ky","HTTPError","posix","APIError","getGenerateURL","getStorageUrl","getVideoFromDoc","purgeBunnyCache","getHandleDelete","purge","storage","stream","collection","doc","filename","req","video","fileUrl","enabled","data","prefix","delete","libraryId","videoId","headers","accept","AccessKey","apiKey","timeout","filePath","join","region","zoneName","err","errorResponse","response","text","payload","logger","error","status","statusText","file","name"],"mappings":"AAEA,OAAOA,MAAMC,SAAS,QAAQ,KAAI;AAClC,SAASC,KAAK,QAAQ,YAAW;AACjC,SAASC,QAAQ,QAAQ,UAAS;AAIlC,SAASC,cAAc,QAAQ,mBAAkB;AACjD,SAASC,aAAa,EAAEC,eAAe,EAAEC,eAAe,QAAQ,aAAY;AAE5E,OAAO,MAAMC,kBAAkB,CAAC,EAAEC,KAAK,EAAEC,OAAO,EAAEC,MAAM,EAAuB;IAC7E,OAAO,OAAO,EAAEC,UAAU,EAAEC,GAAG,EAAEC,QAAQ,EAAEC,GAAG,EAAE;QAC9C,IAAI;YACF,MAAMC,QAAQV,gBAAgBO,KAAKC;YAEnC,IAAIG,UAAyB;YAC7B,IAAI,CAACD,SAASP,SAASA,MAAMS,OAAO,EAAE;gBACpCD,UAAU,MAAMb,eAAe;oBAAEM;oBAASC;gBAAO,GAAG;oBAClDC;oBACAO,MAAMN;oBACNC;oBACAM,QAAQP,IAAIO,MAAM,IAAI;gBACxB;YACF;YAEA,IAAIT,UAAUK,OAAO;gBACnB,MAAMhB,GAAGqB,MAAM,CACb,CAAC,mCAAmC,EAAEV,OAAOW,SAAS,CAAC,QAAQ,EAAEN,MAAMO,OAAO,EAAE,EAChF;oBACEC,SAAS;wBACPC,QAAQ;wBACRC,WAAWf,OAAOgB,MAAM;oBAC1B;oBACAC,SAAS;gBACX;YAEJ,OAAO;gBACL,MAAMC,WAAW3B,MAAM4B,IAAI,CAACjB,IAAIO,MAAM,IAAI,IAAIN;gBAE9C,MAAMd,GAAGqB,MAAM,CACb,CAAC,QAAQ,EAAEhB,cAAcK,QAAQqB,MAAM,EAAE,CAAC,EAAErB,QAAQsB,QAAQ,CAAC,CAAC,EAAEH,UAAU,EAC1E;oBACEL,SAAS;wBACPC,QAAQ;wBACRC,WAAWhB,QAAQiB,MAAM;oBAC3B;oBACAC,SAAS;gBACX;gBAGF,IAAInB,SAASA,MAAMS,OAAO,IAAID,SAAS;oBACrC,MAAMV,gBAAgBU,SAASR,OAAOM;gBACxC;YACF;QACF,EAAE,OAAOkB,KAAK;YACZ,IAAIA,eAAehC,WAAW;gBAC5B,MAAMiC,gBAAgB,MAAMD,IAAIE,QAAQ,CAACC,IAAI;gBAE7CrB,IAAIsB,OAAO,CAACC,MAAM,CAACC,KAAK,CAAC;oBACvBA,OAAO;wBACLJ,UAAUD;wBACVM,QAAQP,IAAIE,QAAQ,CAACK,MAAM;wBAC3BC,YAAYR,IAAIE,QAAQ,CAACM,UAAU;oBACrC;oBACAC,MAAM;wBAAEC,MAAM7B;oBAAS;oBACvBJ,SAASA,QAAQsB,QAAQ;gBAC3B;YACF;YAEAjB,IAAIsB,OAAO,CAACC,MAAM,CAACC,KAAK,CAAC;gBACvBA,OAAON;gBACPS,MAAM;oBAAEC,MAAM7B;gBAAS;gBACvBJ,SAASA,QAAQsB,QAAQ;YAC3B;YAEA,MAAM,IAAI7B,SAAS,CAAC,qBAAqB,EAAEW,UAAU,EAAE;QACzD;IACF;AACF,EAAC"}